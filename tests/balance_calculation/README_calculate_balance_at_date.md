# –§—É–Ω–∫—Ü–∏—è calculate_balance_at_date

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏–∑ –º–æ–¥—É–ª—è `MT5Calculator`.

## –û–ø–∏—Å–∞–Ω–∏–µ

–§—É–Ω–∫—Ü–∏—è `calculate_balance_at_date` –≤—ã—á–∏—Å–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É, —É—á–∏—Ç—ã–≤–∞—è –≤—Å–µ —Å–¥–µ–ª–∫–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å = 0** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- ‚úÖ **–û–ø—Ü–∏—è –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞ –¥–Ω—è** (`end_of_day` –ø–∞—Ä–∞–º–µ—Ç—Ä)
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—á–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω—ã** (`LOCAL_TIMESHIFT = 3`)
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞** —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–¥–µ–ª–æ–∫

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏

```python
def calculate_balance_at_date(
    target_date: datetime,      # –î–∞—Ç–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞
    deals: List,               # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    initial_balance: float = None,  # –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)
    end_of_day: bool = False   # True = –∫–æ–Ω–µ—Ü –¥–Ω—è, False = –Ω–∞—á–∞–ª–æ –¥–Ω—è
) -> float:
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –Ω–∞—á–∞–ª–æ –¥–Ω—è (00:00:00)
balance = mt5_calculator.calculate_balance_at_date(
    target_date=datetime(2025, 10, 10),
    deals=deals
)

# –ö–æ–Ω–µ—Ü –¥–Ω—è (23:59:59)
balance = mt5_calculator.calculate_balance_at_date(
    target_date=datetime(2025, 10, 10),
    deals=deals,
    end_of_day=True
)
```

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç
```bash
python tests/balance_calculation/test_balance_function.py
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
- **10 –æ–∫—Ç—è–±—Ä—è 2025** - —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å —Å —Ç–æ—Ä–≥–æ–≤–ª–µ–π
- **27 —Å–µ–Ω—Ç—è–±—Ä—è 2025** - —Å—É–±–±–æ—Ç–∞ (–≤—ã—Ö–æ–¥–Ω–æ–π)
- **28 —Å–µ–Ω—Ç—è–±—Ä—è 2025** - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (–≤—ã—Ö–æ–¥–Ω–æ–π)

–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- –°—É–±–±–æ—Ç–∞ –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –±–∞–ª–∞–Ω—Å (–Ω–µ—Ç —Ç–æ—Ä–≥–æ–≤–ª–∏)
- –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –Ω–∞—á–∞–ª–æ–º –∏ –∫–æ–Ω—Ü–æ–º –¥–Ω—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞**: –ú–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ UTC —Å —É—á–µ—Ç–æ–º `LOCAL_TIMESHIFT`
2. **–¢–∏–ø—ã —Å–¥–µ–ª–æ–∫**:
   - `type == 2`: –ò–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (–¥–µ–ø–æ–∑–∏—Ç—ã/—Å–Ω—è—Ç–∏—è)
   - –û—Å—Ç–∞–ª—å–Ω—ã–µ: –¢–æ—Ä–≥–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ (–ø—Ä–∏–±—ã–ª—å + –∫–æ–º–∏—Å—Å–∏—è + —Å–≤–æ–ø)
3. **–†–∞—Å—á–µ—Ç**: –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å + –≤—Å–µ —Å–¥–µ–ª–∫–∏ –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã

## –ü—Ä–∏–º–µ—Ä—ã –≤—ã–≤–æ–¥–∞

```
üßÆ –¢–ï–°–¢ –§–£–ù–ö–¶–ò–ò calculate_balance_at_date
==================================================
üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...
‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Å–¥–µ–ª–æ–∫: 3004
üè¶ –ê–∫–∫–∞—É–Ω—Ç: 25235504
üìà –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å MT5: 11968.11

üìÖ 10 –æ–∫—Ç—è–±—Ä—è (2025-10-10):
   ‚Ä¢ üåÖ –ù–∞—á–∞–ª–æ –¥–Ω—è: 10938.49
   ‚Ä¢ üåÜ –ö–æ–Ω–µ—Ü –¥–Ω—è:  10491.50
   ‚Ä¢ üìä –†–∞–∑–Ω–∏—Ü–∞:    -446.99
   ‚Ä¢ üìà –û—Ç —Ç–µ–∫—É—â–µ–≥–æ: +1476.61

üìÖ –°—É–±–±–æ—Ç–∞ (2025-09-27):
   ‚Ä¢ üåÖ –ù–∞—á–∞–ª–æ –¥–Ω—è: 6833.09
   ‚Ä¢ üåÜ –ö–æ–Ω–µ—Ü –¥–Ω—è:  6833.09
   ‚Ä¢ üìä –†–∞–∑–Ω–∏—Ü–∞:    +0.00
   ‚Ä¢ üìà –û—Ç —Ç–µ–∫—É—â–µ–≥–æ: +5135.02

üìÖ –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (2025-09-28):
   ‚Ä¢ üåÖ –ù–∞—á–∞–ª–æ –¥–Ω—è: 6833.09
   ‚Ä¢ üåÜ –ö–æ–Ω–µ—Ü –¥–Ω—è:  6833.09
   ‚Ä¢ üìä –†–∞–∑–Ω–∏—Ü–∞:    +0.00
   ‚Ä¢ üìà –û—Ç —Ç–µ–∫—É—â–µ–≥–æ: +5135.02

==================================================
‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!
```

### –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏:

```bash
# –†–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è
python tests/balance_calculation/balance_by_date.py --date 2025-09-27

# –†–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –∫–æ–Ω–µ—Ü –¥–Ω—è
python tests/balance_calculation/balance_by_date.py --date 2025-09-27 --end-of-day

# –†–∞—Å—á–µ—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –Ω–∞—á–∞–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º
python tests/balance_calculation/balance_by_date.py --date 2025-10-10 --initial-balance 1000

# –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–¥–µ–ª–∫–∞—Ö
python tests/balance_calculation/balance_by_date.py --date 2025-09-30 --verbose
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç:**
- `2025-09-27` (ISO —Ñ–æ—Ä–º–∞—Ç)
- `27-09-2025` (–ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)
- `27/09/2025` (–§–æ—Ä–º–∞—Ç —Å –∫–æ—Å–æ–π —á–µ—Ä—Ç–æ–π)
- `27.09.2025` (–§–æ—Ä–º–∞—Ç —Å —Ç–æ—á–∫–æ–π)

## –ü—Ä–∏–º–µ—Ä—ã –≤—ã–≤–æ–¥–∞

```
üßÆ –†–ê–°–ß–ï–¢ –ë–ê–õ–ê–ù–°–ê –ù–ê –î–ê–¢–£
==================================================
üìÖ –¶–µ–ª–µ–≤–∞—è –¥–∞—Ç–∞: 27.09.2025
üïê –†–µ–∂–∏–º: –ù–∞—á–∞–ª–æ –¥–Ω—è

üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...
‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Å–¥–µ–ª–æ–∫: 3004
üè¶ –ê–∫–∫–∞—É–Ω—Ç: 25235504
üìà –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å MT5: 11968.11

üßÆ –†–ï–ó–£–õ–¨–¢–ê–¢:
------------------------------
üìä –ë–∞–ª–∞–Ω—Å: 6833.09
üìà –û—Ç —Ç–µ–∫—É—â–µ–≥–æ: +5135.02

==================================================
‚úÖ –†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!
```